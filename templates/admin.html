{% extends "base.html" %}
{% block title %}Admin Panel â€” Community Help System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 slide-up">
            <div>
                <h1 class="fw-800 mb-1">
                    <i class="bi bi-shield-lock-fill me-2"
                        style="background: linear-gradient(135deg, #f59e0b, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>Admin
                    Panel
                </h1>
                <p class="text-muted mb-0">Manage requests â€” Filter, sort, and update statuses</p>
            </div>
            <div class="badge bg-warning text-dark fs-6 px-3 py-2">
                <i class="bi bi-collection me-1"></i>{{ requests|length }} Results
            </div>
        </div>

        <!-- Stat Cards -->
        <div class="row g-3 mb-4 slide-up" style="animation-delay: 0.05s;">
            <div class="col-6 col-md-3">
                <div class="stat-card stat-total">
                    <div class="stat-number">{{ requests|length }}</div>
                    <div class="stat-label">Showing</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-emergency">
                    <div class="stat-number">{{ requests|selectattr('urgency', 'equalto', 'Emergency')|list|length }}
                    </div>
                    <div class="stat-label">Emergency</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-unsolved">
                    <div class="stat-number">{{ requests|selectattr('solved_status', 'equalto', 'Unsolved')|list|length
                        }}</div>
                    <div class="stat-label">Unsolved</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-solved">
                    <div class="stat-number">{{ requests|selectattr('solved_status', 'equalto', 'Solved')|list|length }}
                    </div>
                    <div class="stat-label">Solved</div>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="card filter-card mb-4 slide-up" style="animation-delay: 0.1s;">
            <div class="card-body p-3">
                <form method="GET" action="{{ url_for('admin') }}" class="row g-3 align-items-end" id="filterForm">
                    <div class="col-md-4">
                        <label class="form-label fw-600 small text-uppercase">
                            <i class="bi bi-funnel me-1"></i>Urgency Filter
                        </label>
                        <select class="form-select" name="urgency" id="urgencyFilter">
                            <option value="all" {% if urgency_filter=='all' %}selected{% endif %}>All Urgency Levels
                            </option>
                            <option value="emergency" {% if urgency_filter=='emergency' %}selected{% endif %}>ðŸ”´
                                Emergency Only</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-600 small text-uppercase">
                            <i class="bi bi-check2-square me-1"></i>Status Filter
                        </label>
                        <select class="form-select" name="status" id="statusFilter">
                            <option value="all" {% if status_filter=='all' %}selected{% endif %}>All Statuses</option>
                            <option value="unsolved" {% if status_filter=='unsolved' %}selected{% endif %}>ðŸŸ¡ Unsolved
                                Only</option>
                            <option value="solved" {% if status_filter=='solved' %}selected{% endif %}>ðŸŸ¢ Solved Only
                            </option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="bi bi-search me-1"></i>Apply Filters
                        </button>
                        <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary" title="Reset Filters">
                            <i class="bi bi-x-circle"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>

        {% if requests|length == 0 %}
        <!-- Empty State -->
        <div class="text-center py-5 fade-in">
            <div class="empty-icon mb-3">
                <i class="bi bi-inbox"></i>
            </div>
            <h3 class="text-muted">No Requests Found</h3>
            <p class="text-muted">No requests match your current filters.</p>
            <a href="{{ url_for('admin') }}" class="btn btn-primary">
                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Filters
            </a>
        </div>
        {% else %}
        <!-- Admin Requests Table -->
        <div class="table-responsive slide-up" style="animation-delay: 0.15s;">
            <table class="table table-custom table-admin" id="adminTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Urgency</th>
                        <th>Status</th>
                        <th>Date & Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr class="request-row urgency-row-{{ req.urgency|lower }}">
                        <td class="fw-bold">{{ req.id }}</td>
                        <td>
                            <div class="fw-600">{{ req.name }}</div>
                        </td>
                        <td><span class="text-nowrap">{{ req.phone }}</span></td>
                        <td>
                            <div class="address-cell" title="{{ req.address }}">
                                {{ req.address[:40] }}{% if req.address|length > 40 %}...{% endif %}
                            </div>
                        </td>
                        <td><span class="category-badge">{{ req.category }}</span></td>
                        <td>
                            <div class="description-cell" title="{{ req.description }}">
                                {{ req.description[:60] }}{% if req.description|length > 60 %}...{% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge urgency-badge-sm urgency-{{ req.urgency|lower }}">
                                {% if req.urgency == 'Emergency' %}
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                {% elif req.urgency == 'Medium' %}
                                <i class="bi bi-exclamation-circle-fill me-1"></i>
                                {% else %}
                                <i class="bi bi-info-circle-fill me-1"></i>
                                {% endif %}
                                {{ req.urgency }}
                            </span>
                        </td>
                        <td>
                            <span class="badge status-badge status-{{ req.solved_status|lower }}">
                                {% if req.solved_status == 'Solved' %}
                                <i class="bi bi-check-circle-fill me-1"></i>
                                {% else %}
                                <i class="bi bi-clock-fill me-1"></i>
                                {% endif %}
                                {{ req.solved_status }}
                            </span>
                        </td>
                        <td><span class="text-nowrap small">{{ req.created_at }}</span></td>
                        <td>
                            <form method="POST" action="{{ url_for('toggle_status', request_id=req.id) }}"
                                class="d-inline">
                                <input type="hidden" name="urgency_filter" value="{{ urgency_filter }}">
                                <input type="hidden" name="status_filter" value="{{ status_filter }}">
                                {% if req.solved_status == 'Unsolved' %}
                                <button type="submit" class="btn btn-sm btn-success action-btn" title="Mark as Solved">
                                    <i class="bi bi-check-lg me-1"></i>Solve
                                </button>
                                {% else %}
                                <button type="submit" class="btn btn-sm btn-outline-warning action-btn"
                                    title="Mark as Unsolved">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reopen
                                </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}