{% extends "base.html" %}
{% block title %}All Requests â€” Volunteer View{% endblock %}

{% block content %}

<!-- iOS-style Emergency Alert Popup Modal -->
{% if volunteer and emergency_alerts|length > 0 %}
<div id="iosAlertOverlay" class="ios-alert-overlay">
    <div class="ios-alert-container">
        {% for alert in emergency_alerts %}
        <div class="ios-alert-dialog slide-up" style="animation-delay: {{ loop.index0 * 0.15 }}s;"
            data-alert-index="{{ loop.index0 }}">
            <!-- Alert Icon -->
            <div class="ios-alert-icon">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <!-- Alert Title -->
            <div class="ios-alert-title">ðŸš¨ Emergency Alert</div>
            <!-- Alert Message -->
            <div class="ios-alert-message">
                <strong>{{ alert.name }}</strong> needs urgent help!<br>
                <span class="ios-alert-category">{{ alert.category }}</span><br>
                {{ alert.description[:120] }}{% if alert.description|length > 120 %}...{% endif %}
            </div>
            <!-- Alert Meta -->
            <div class="ios-alert-meta">
                <i class="bi bi-geo-alt me-1"></i>{{ alert.address[:40] }}{% if alert.address|length > 40 %}...{% endif
                %}
                <br>
                <i class="bi bi-telephone me-1"></i>{{ alert.phone }}
                <span class="mx-1">Â·</span>
                <i class="bi bi-clock me-1"></i>{{ alert.created_at }}
            </div>
            <!-- Alert Actions (iOS-style) -->
            <div class="ios-alert-actions">
                <a href="tel:{{ alert.phone }}" class="ios-alert-btn ios-alert-btn-primary">
                    <i class="bi bi-telephone-fill me-1"></i>Call Now
                </a>
                <button class="ios-alert-btn ios-alert-btn-default ios-alert-ok-btn" onclick="dismissSingleAlert(this)">
                    OK
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Emergency Alert Banner for Volunteers -->
{% if volunteer and emergency_alerts|length > 0 %}
<div class="alert mb-4 slide-up"
    style="background: rgba(239, 68, 68, 0.08); border: 1.5px solid rgba(239, 68, 68, 0.25); border-radius: 16px;">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h5 class="mb-2" style="color: #EF4444;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>ðŸš¨ {{ emergency_alerts|length }} New Emergency
                Alert{{ 's' if emergency_alerts|length > 1 else '' }}!
            </h5>
            <p class="mb-2 text-muted small">The following emergency requests need immediate attention:</p>
            {% for alert in emergency_alerts %}
            <div class="mb-2 p-2 rounded" style="background: rgba(239, 68, 68, 0.05); border-left: 3px solid #EF4444;">
                <strong style="color: var(--text-primary);">{{ alert.name }}</strong>
                <span class="text-muted mx-1">Â·</span>
                <span class="small" style="color: #EF4444;"><i class="bi bi-tag me-1"></i>{{ alert.category }}</span>
                <span class="text-muted mx-1">Â·</span>
                <span class="small text-muted"><i class="bi bi-geo-alt me-1"></i>{{ alert.address[:50] }}{% if
                    alert.address|length > 50 %}...{% endif %}</span>
                <span class="text-muted mx-1">Â·</span>
                <span class="small text-muted"><i class="bi bi-clock me-1"></i>{{ alert.created_at }}</span>
                <br>
                <span class="small" style="color: var(--text-secondary);">{{ alert.description[:100] }}{% if
                    alert.description|length > 100 %}...{% endif %}</span>
            </div>
            {% endfor %}
        </div>
        <form action="{{ url_for('dismiss_alerts') }}" method="POST" class="ms-3">
            <button type="submit" class="btn btn-outline-secondary btn-sm" title="Dismiss alerts"
                style="border-radius: 9999px;">
                <i class="bi bi-check2-all me-1"></i>Dismiss
            </button>
        </form>
    </div>
</div>
{% endif %}

<!-- Volunteer Login Prompt (for non-logged-in visitors) -->
{% if not volunteer and not session.get('volunteer_email') %}
<div class="alert mb-4 slide-up"
    style="background: var(--accent-soft); border: 1px solid var(--border-color-strong); border-radius: 16px;">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <p class="mb-0 small">
            <i class="bi bi-bell me-1" style="color: #8B5CF6;"></i>
            <strong>Want emergency alerts?</strong> Register as a volunteer to get notified when new emergencies arrive.
        </p>
        <div class="d-flex gap-2">
            <a href="{{ url_for('volunteer_login') }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-box-arrow-in-right me-1"></i>Login
            </a>
            <a href="{{ url_for('volunteer_register') }}" class="btn btn-primary btn-sm">
                <i class="bi bi-person-plus me-1"></i>Register
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 slide-up">
            <div>
                <h1 class="fw-800 mb-1">
                    <i class="bi bi-clipboard-data me-2"
                        style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>All
                    Help Requests
                </h1>
                <p class="text-muted mb-0">Volunteer View â€” Browse all community help requests</p>
            </div>
            <div class="badge bg-primary fs-6 px-3 py-2">
                <i class="bi bi-collection me-1"></i>{{ requests|length }} Total
            </div>
        </div>

        <!-- Stat Cards -->
        {% if requests|length > 0 %}
        <div class="row g-3 mb-4 slide-up" style="animation-delay: 0.1s;">
            <div class="col-6 col-md-3">
                <div class="stat-card stat-total">
                    <div class="stat-number">{{ requests|length }}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-emergency">
                    <div class="stat-number">{{ requests|selectattr('urgency', 'equalto', 'Emergency')|list|length }}
                    </div>
                    <div class="stat-label">Emergency</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-unsolved">
                    <div class="stat-number">{{ requests|selectattr('solved_status', 'equalto', 'Unsolved')|list|length
                        }}</div>
                    <div class="stat-label">Unsolved</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-solved">
                    <div class="stat-number">{{ requests|selectattr('solved_status', 'equalto', 'Solved')|list|length }}
                    </div>
                    <div class="stat-label">Solved</div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if requests|length == 0 %}
        <!-- Empty State -->
        <div class="text-center py-5 fade-in">
            <div class="empty-icon mb-3">
                <i class="bi bi-inbox"></i>
            </div>
            <h3 class="text-muted">No Requests Yet</h3>
            <p class="text-muted">Be the first to submit a help request.</p>
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Submit Request
            </a>
        </div>
        {% else %}
        <!-- Requests Table -->
        <div class="table-responsive slide-up" style="animation-delay: 0.15s;">
            <table class="table table-custom" id="requestsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Urgency</th>
                        <th>Status</th>
                        <th>Date & Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr class="request-row urgency-row-{{ req.urgency|lower }}">
                        <td class="fw-bold">{{ req.id }}</td>
                        <td>
                            <div class="fw-600">{{ req.name }}</div>
                        </td>
                        <td><span class="text-nowrap">{{ req.phone }}</span></td>
                        <td><span class="category-badge">{{ req.category }}</span></td>
                        <td>
                            <div class="description-cell" title="{{ req.description }}">
                                {{ req.description[:80] }}{% if req.description|length > 80 %}...{% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge urgency-badge-sm urgency-{{ req.urgency|lower }}">
                                {% if req.urgency == 'Emergency' %}
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                {% elif req.urgency == 'Medium' %}
                                <i class="bi bi-exclamation-circle-fill me-1"></i>
                                {% else %}
                                <i class="bi bi-info-circle-fill me-1"></i>
                                {% endif %}
                                {{ req.urgency }}
                            </span>
                        </td>
                        <td>
                            <span class="badge status-badge status-{{ req.solved_status|lower }}">
                                {% if req.solved_status == 'Solved' %}
                                <i class="bi bi-check-circle-fill me-1"></i>
                                {% else %}
                                <i class="bi bi-clock-fill me-1"></i>
                                {% endif %}
                                {{ req.solved_status }}
                            </span>
                        </td>
                        <td><span class="text-nowrap small">{{ req.created_at }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if volunteer and emergency_alerts|length > 0 %}
<script>
    // Vibrate on mobile if supported
    document.addEventListener('DOMContentLoaded', function () {
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200, 100, 200]);
        }
    });

    function dismissSingleAlert(btn) {
        const dialog = btn.closest('.ios-alert-dialog');
        dialog.style.transform = 'scale(0.8)';
        dialog.style.opacity = '0';
        setTimeout(function () {
            dialog.style.display = 'none';
            // Check if all alerts are dismissed
            const remaining = document.querySelectorAll('.ios-alert-dialog');
            let allHidden = true;
            remaining.forEach(function (d) {
                if (d.style.display !== 'none') allHidden = false;
            });
            if (allHidden) {
                const overlay = document.getElementById('iosAlertOverlay');
                overlay.style.opacity = '0';
                setTimeout(function () {
                    overlay.style.display = 'none';
                    // Auto-dismiss on server
                    fetch('{{ url_for("dismiss_alerts") }}', { method: 'POST' });
                }, 300);
            }
        }, 250);
    }
</script>
{% endif %}
{% endblock %}